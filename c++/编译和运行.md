# 程序的编译和连接过程


**一个程序到可执行程序一般需要经过预编译，编译，汇编，链接四个步骤**

## 预编译
预编译的主要处理文件中以"#"开始的预编译指令，比如"#include","#define"等，主要包括：

1. 将所有的"#define"删除，并且展开所有的宏定义
2. 处理所有的预编译指令，比如"#if","#ifdef","#endif"
3. 处理"#include"指令，将包含的文件插入到该预编指令的位置。这个过程是递归进行的，也就是说被包含的文件可能还包含其他的文件，
4. 删除所有的注释
5. 添加行号和文件标识，以便于编译时编译器产生调试的行号信息以及用于编译时产生的编译错误，或警告时显示的行号
6. 保留所有的#program编译指令

## 编译

**编译过程就是把预编译生成的文件进行一系列的词法分析，语法分析，语义分析，以及优化后生成的汇编代码**

## 汇编

**汇编就是将汇编代码转化成机器可以执行的指令，得到目标文件,目标文件中所存放的也就是与源程序等效的目标的机器语言代码。**
目标文件由段组成。通常一个目标文件中至少有两个段：

- 代码段:该段中所包含的主要是程序的指令。该段一般是可读和可执行的，但一般却不可写。
- 数据段:主要存放程序中要用到的各种全局变量或静态的数据。一般数据段都是可读，可写，可执行的。



## 链接

**链接将目标文件进行处理，得到可执行文件。**

由汇编程序生成的目标文件并不能立即就被执行，其中可能还有许多没有解决的问题。例如，某个源文件中的函数可能引用了另一个源文件中定义的某个符号（如变量或者函数调用等）;在程序中可能调用了某个库文件中的函数，等等。所有的这些问题，都需要经链接程序的处理方能得以解决。
链接程序的主要工作就是将有关的目标文件彼此相连接，也即将在一个文件中引用的符号同该符号在另外一个文件中的定义连接起来，使得所有的这些目标文件成为一个能够诶操作系统装入执行的统一整体。

根据开发人员指定的同库函数的链接方式的不同，链接处理可分为两种：

- 静态链接　在这种链接方式下，函数的代码将从其所在地静态链接库中被拷贝到最终的可执行程序中。这样该程序在被执行时这些代码将被装入到该进程的虚拟地址空间中。静态链接库实际上是一个目标文件的集合，其中的每个文件含有库中的一个或者一组相关函数的代码。(静态链接将链接库的代码复制到可执行程序中，使得可执行程序体积变大)

- 动态链接　　在此种方式下，函数的代码被放到称作是动态链接库或共享对象的某个目标文件中。链接程序此时所作的只是在最终的可执行程序中记录下共享对象的名字以及其它少量的登记信息。在此可执行文件被执行时，动态链接库的全部内容将被映射到运行时相应进程的虚地址空间。动态链接程序将根据可执行程序中记录的信息找到相应的函数代码。（动态链接指的是需要链接的代码放到一个共享对象中，共享对象映射到进程虚地址空间，链接程序记录可执行程序将来需要用的代码信息，根据这些信息迅速定位相应的代码片段。）

对于可执行文件中的函数调用，可分别采用动态链接或静态链接的方法。使用动态链接能够使最终的可执行文件比较短小，并且当共享对象被多个进程使用时能节约一些内存，因为在内存中只需要保存一份此共享对象的代码。但并不是使用动态链接就一定比使用静态链接要优越。在某些情况下动态链接可能带来一些性能上损害。
